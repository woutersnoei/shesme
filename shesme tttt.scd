(
~shesme = ~shesme ? EM();

~shesme.tttt = ~shesme.tttt ? EM();

~shesme.tttt.loadBuffers = { |evt, action|
	evt.buffers = Buffer.readDir( thisProcess.nowExecutingPath.dirname.dirname +/+ "samples/tttt",
		action: { action.value });
};

~shesme.tttt.amp = 0.1;
~shesme.tttt.transpose = 0;
~shesme.tttt.fadeOut = 0;
~shesme.tttt.speed = 5;

(
SynthDef( "shesme_tttt", { |bufnum = 0, amp = 0.1, fadeOut = 0, offset = 0, rate = 1, pan = 0|
	var sig;
	sig = PlayBuf.ar( 1, bufnum, rate, 1, 
		(BufRateScale.kr(bufnum) / rate) * offset * SampleRate.ir, doneAction:2 
	) * amp;
	sig = sig * Env([1,1,0],[1-fadeOut, fadeOut] * ((BufDur.kr(bufnum) - offset)/rate), -12).ar(2);
	sig = PanAz.ar( 4, BLowCut.ar( sig, 250, 2 ), pan );
	OffsetOut.ar( 0, sig );
}).store;
);

(
~shesme.tttt.start = { |evt|
	evt.end;
	evt.task = {
		var index, time, elapsed, wait;
		var stream, times, pan;
		var sortedBuffers;
		stream = Pbrown( 0, (evt.buffers.size-1).asInt, 10, inf ).asStream;
		sortedBuffers = [ evt.freqs, evt.buffers ].flop.sort({ |a,b| a[0] <= b[0] }).flop[1];
		times = (Pbrown(0.0,1.0,0.1,inf).linlin(0,1,1/3,3) * Pwhite(0.9,1.1,inf)).asStream;
		pan = Pwhite(-0.25,0.25,inf).asStream;
		//stream = Pseq( [ Pseries(0, 1, evt.buffers.size ) ], inf ).asStream;
		//times = Pwrand( [ Pseq([0.05,0.05,0.05,0.05],1), 0.1 ], [0.1, 0.9 ], inf ).asStream;
		// stream = PintL( Pwhite(0, evt.buffers.size.asInt, inf ), 0.05 ).round(1).asStream;
		loop {
			index = stream.next;
			Synth.sched( 0.2, "shesme_tttt", [ 	
				\bufnum, sortedBuffers[ index ], 
				\amp, (evt.amp ? 0.1)/evt.peaks[evt.buffers.indexOf( sortedBuffers[ index ] )],
				\pan, pan.next, //0.5.rand2,
				\fadeOut, evt.fadeOut ? 0,
				\offset, evt.peakTimes[evt.buffers.indexOf( sortedBuffers[ index ] )],
				\rate, evt.transpose.midiratio * evt.freqs.mean / evt.freqs[
					evt.buffers.indexOf( sortedBuffers[ index ] )
				]
			]);
			time = times.next;
			elapsed = 0;
			while { elapsed < (time / evt.speed) } {
				wait = 0.25.min( (time / evt.speed) - elapsed );
				elapsed = elapsed + wait;
				wait.wait;
			};
		};
	}.fork;
};
);

~shesme.tttt.end = { |evt|
	evt.task.stop;
	evt.task = nil;
};

/*

~shesme.tttt.loadBuffers;

~shesme.tttt.start;

~shesme.tttt.freqs.mean / ~shesme.tttt.freqs[0]


*/

(
~shesme.tttt.freqs = [ 9282.7265625, 8781.8955078125, 6147.7939453125, 9159.291015625, 8567.646484375, 7389.9130859375, 8188.2456054688, 6932.4096679688, 5710.787109375, 6136.423828125, 5715.0239257812, 5660.8427734375, 6182.1899414062, 9004.3623046875, 7633.572265625, 9013.935546875, 6927.1396484375, 6440.3017578125, 6751.7470703125, 6448.3168945312, 7663.6801757812, 8681.2021484375, 8513.8779296875, 7328.6284179688, 7083.1567382812, 8405.041015625, 8339.4794921875, 8379.26953125, 8096.0107421875, 6039.919921875, 8364.5234375, 8641.6455078125, 7608.9697265625, 8479.462890625, 6808.572265625, 9668.3251953125, 9196.294921875, 7999.2900390625, 8335.5166015625, 9662.654296875, 9198.919921875, 8620.580078125, 8348.056640625, 8310.109375, 8316.2216796875, 7363.1411132812, 8228.4033203125, 8673.5966796875, 8665.552734375, 8696.9267578125, 7532.2768554688, 7461.36328125, 6791.4130859375, 7238.005859375, 8197.9521484375, 8365.564453125, 7208.6040039062, 7108.125, 6823.1342773438, 6063.1811523438, 7682.4853515625, 6630.501953125, 6823.1479492188, 9004.880859375, 8365.232421875, 8239.8984375, 9206.6630859375, 7324.6918945312, 8301.3974609375, 8946.61328125, 8753.03125, 9661.2392578125, 8821.556640625, 8583.3837890625, 8218.291015625, 7667.6220703125, 7725.7880859375, 7842.9409179688, 6587.2822265625, 7581.9272460938, 8074.7309570312, 8397.51953125, 8723.3359375, 8599.2861328125, 8329.4375, 7901.3544921875, 8238.6533203125, 7778.8325195312, 7179.5952148438, 5896.3862304688, 7860.1694335938, 7259.486328125, 6011.9990234375, 6012.9399414062, 7499.8452148438, 6524.8701171875, 5846.9926757812, 6042.9326171875, 5794.046875, 6058.1938476562, 6669.5380859375, 5384.259765625, 5167.685546875, 4713.6547851562, 5940.1298828125, 6903.1884765625, 6272.1416015625, 5265.3818359375, 5591.1962890625, 6222.4853515625, 5750.2778320312, 6407.8364257812, 6597.923828125, 6507.0146484375, 6911.2612304688, 5737.578125, 6470.619140625, 4860.9052734375, 5255.2548828125, 4832.6782226562, 4969.720703125, 5655.9428710938, 5720.6967773438, 7300.1616210938, 7216.0102539062, 6817.0805664062, 6535.6059570312, 7228.892578125, 6358.1625976562, 6572.1235351562, 7803.5087890625, 7505.6977539062, 7488.3828125, 8680.283203125, 6595.0869140625, 7291.9765625, 8026.0463867188, 7102.4291992188, 7799.3120117188, 7430.4736328125, 7548.5610351562, 7289.3227539062, 7279.2504882812, 7294.6982421875, 7480.5756835938, 7952.7446289062, 7749.7709960938, 7740.7470703125, 7145.9057617188, 7868.671875, 7403.58984375, 5805.6196289062, 4954.9208984375, 6354.4418945312, 6491.1044921875, 7095.833984375, 7407.8134765625, 8098.8974609375, 8769.583984375, 7556.8974609375, 5928.1088867188, 6157.361328125, 5696.30078125, 7288.7280273438, 7799.5815429688, 7924.41796875, 6113.5629882812, 6904.6494140625, 7122.4682617188, 7386.2138671875, 5918.9091796875, 6391.9536132812, 7274.1586914062, 6283.4145507812, 5351.2509765625, 6197.9047851562, 6407.041015625, 6798.99609375, 5028.9916992188, 5177.6142578125, 6689.0751953125, 5077.8989257812, 5634.22265625, 6490.6655273438, 6223.4750976562, 6964.4716796875, 7425.3251953125, 6720.7690429688, 5616.8071289062, 6641.6235351562, 6930.369140625, 5758.5727539062, 6397.6494140625, 5846.8090820312, 5862.6557617188, 6872.6953125, 6486.6557617188, 7799.2290039062, 6468.8764648438, 6263.9697265625, 9346.720703125, 9592.8828125, 5814.240234375, 8760.4521484375, 8918.603515625, 9242.6962890625, 8654.02734375, 9159.3359375, 8677.5146484375, 8217.79296875, 8085.384765625, 7583.748046875, 9261.8125, 4447.4077148438, 8763.34765625, 8848.1826171875, 8205.7822265625, 8009.6333007812, 6855.7309570312, 7209.8413085938, 8622.5234375, 7630.2221679688, 7349.556640625, 8372.939453125, 4181.91796875, 6012.4877929688, 6663.7709960938, 6752.7045898438, 7791.19140625, 6257.3090820312, 6189.65234375, 8056.5244140625, 8306.7763671875, 8456.650390625, 7239.1879882812, 5479.5883789062, 9112.5244140625, 8635.2568359375, 7246.587890625, 5976.0087890625, 7854.7470703125, 6707.5166015625, 6383.0317382812, 6160.4038085938, 6131.291015625, 5183.7841796875, 5499.2817382812, 5846.9965820312, 5600.6518554688, 5166.2543945312, 4888.5708007812, 6500.662109375, 4830.73046875, 6789.0551757812, 5762.9326171875, 5996.0239257812, 6232.1850585938, 4761.3173828125, 5447.9487304688, 6111.2685546875, 4727.3017578125, 6363.8676757812, 5852.05078125, 6529.4252929688, 5489.7827148438, 6152.0576171875, 6333.1323242188, 5345.6787109375, 5893.0102539062, 7018.9780273438, 6260.859375, 5347.8447265625, 5597.2416992188, 4817.404296875, 4508.1879882812, 5879.8403320312, 4210.923828125, 5887.51171875, 5635.80078125, 5708.2788085938, 4344.3701171875, 5706.97265625, 4749.9658203125, 5297.6586914062, 4705.537109375, 4748.7353515625, 6267.8251953125, 4420.0556640625, 5079.42578125, 6063.7314453125, 4673.6938476562, 5395.5659179688, 4811.119140625, 4686.044921875, 5409.0849609375, 7067.814453125, 5317.646484375, 8166.3071289062 ];
);

(
~shesme.tttt.peaks = [ 0.36619162559509, 0.38343751430511, 0.35349190235138, 0.5858166217804, 0.43845212459564, 0.65661263465881, 0.49235379695892, 0.32413387298584, 0.31718420982361, 0.11350405216217, 0.19968974590302, 0.28799211978912, 0.34066200256348, 0.48243689537048, 0.41074812412262, 0.38043451309204, 0.30724060535431, 0.34080946445465, 0.26656973361969, 0.052101492881775, 0.18963730335236, 0.41181468963623, 0.36972844600677, 0.28191637992859, 0.1346150636673, 0.21677720546722, 0.45538878440857, 0.45194494724274, 0.24793148040771, 0.13620793819427, 0.059829354286194, 0.19237768650055, 0.30195343494415, 0.2987949848175, 0.1580296754837, 0.20933127403259, 0.32872271537781, 0.053358793258667, 0.1544440984726, 0.21296381950378, 0.28767907619476, 0.23049747943878, 0.22765123844147, 0.25311613082886, 0.24970185756683, 0.23883879184723, 0.24073469638824, 0.29106843471527, 0.30046820640564, 0.23274910449982, 0.2646461725235, 0.28186893463135, 0.069386124610901, 0.2472095489502, 0.098015666007996, 0.21475529670715, 0.088477253913879, 0.19009399414062, 0.073324084281921, 0.064481496810913, 0.057718992233276, 0.13340306282043, 0.18187379837036, 0.24410605430603, 0.15464532375336, 0.14846444129944, 0.22651922702789, 0.20607602596283, 0.26246821880341, 0.13825750350952, 0.24614906311035, 0.24287509918213, 0.25549805164337, 0.26927316188812, 0.25663018226624, 0.24823534488678, 0.27842366695404, 0.17890810966492, 0.10863828659058, 0.069846034049988, 0.060315251350403, 0.043017864227295, 0.13063836097717, 0.30618715286255, 0.42978847026825, 0.35636818408966, 0.3639817237854, 0.23685348033905, 0.19373404979706, 0.19913256168365, 0.24818909168243, 0.19905638694763, 0.23340582847595, 0.148432970047, 0.24471282958984, 0.42952358722687, 0.32478559017181, 0.28051018714905, 0.28407967090607, 0.21809828281403, 0.21528935432434, 0.2656866312027, 0.15201020240784, 0.14811074733734, 0.094847798347473, 0.3784556388855, 0.26360523700714, 0.18981528282166, 0.18223631381989, 0.32880806922913, 0.12047386169434, 0.31046092510223, 0.34229922294617, 0.43869435787201, 0.62120974063873, 0.25867450237274, 0.18495035171509, 0.26728749275208, 0.14342403411865, 0.095501184463501, 0.25528216362, 0.17424583435059, 0.24403285980225, 0.6200715303421, 0.42594313621521, 0.37154567241669, 0.47224164009094, 0.4785327911377, 0.4050999879837, 0.40691804885864, 0.3324054479599, 0.44520604610443, 0.41923689842224, 0.31606638431549, 0.40353536605835, 0.49865508079529, 0.49450516700745, 0.53122317790985, 0.43054687976837, 0.43391251564026, 0.49905264377594, 0.39221847057343, 0.37958693504333, 0.35225069522858, 0.43360126018524, 0.43674910068512, 0.46319735050201, 0.51782047748566, 0.42948889732361, 0.45237255096436, 0.50768899917603, 0.48107862472534, 0.37896633148193, 0.37044954299927, 0.39475870132446, 0.43250524997711, 0.46393370628357, 0.48713982105255, 0.53189420700073, 0.3916107416153, 0.35780143737793, 0.27793598175049, 0.36394822597504, 0.35886573791504, 0.44154608249664, 0.37867450714111, 0.40838170051575, 0.38906252384186, 0.41498231887817, 0.43557703495026, 0.42246127128601, 0.40961706638336, 0.44503629207611, 0.33331072330475, 0.33055925369263, 0.36448860168457, 0.31498873233795, 0.31122577190399, 0.31410825252533, 0.32140004634857, 0.48023104667664, 0.23316323757172, 0.29083716869354, 0.34172320365906, 0.31404054164886, 0.35084557533264, 0.3613942861557, 0.36542546749115, 0.26927924156189, 0.31288695335388, 0.32105767726898, 0.37098097801208, 0.29062640666962, 0.4198921918869, 0.33444356918335, 0.19483244419098, 0.16671800613403, 0.09302031993866, 0.36712336540222, 0.414097905159, 0.65696287155151, 0.60822117328644, 0.35775089263916, 0.49030888080597, 0.42060041427612, 0.44589948654175, 0.49937546253204, 0.51204800605774, 0.54642629623413, 0.32687366008759, 0.39220523834229, 0.37433755397797, 0.46668076515198, 0.25016212463379, 0.24355864524841, 0.40762221813202, 0.43963742256165, 0.43637108802795, 0.35367107391357, 0.28066110610962, 0.38535094261169, 0.42512333393097, 0.37350594997406, 0.38872420787811, 0.28160893917084, 0.38276124000549, 0.40522885322571, 0.32231962680817, 0.41142141819, 0.41257834434509, 0.39108955860138, 0.46473503112793, 0.44958078861237, 0.45340871810913, 0.32189631462097, 0.30014288425446, 0.51559197902679, 0.39554929733276, 0.25430154800415, 0.29786241054535, 0.42902863025665, 0.3814502954483, 0.38603448867798, 0.47653639316559, 0.51640212535858, 0.34543168544769, 0.37048614025116, 0.43866801261902, 0.35717678070068, 0.32885777950287, 0.42147135734558, 0.4774386882782, 0.39160025119781, 0.43034684658051, 0.3896290063858, 0.40926492214203, 0.45577490329742, 0.39292395114899, 0.34432601928711, 0.42675089836121, 0.40289378166199, 0.44229555130005, 0.39511573314667, 0.52655959129333, 0.34514367580414, 0.6301304101944, 0.7079998254776, 0.33466148376465, 0.36224555969238, 0.3726487159729, 0.42418539524078, 0.3857569694519, 0.37588882446289, 0.36448669433594, 0.36389422416687, 0.46038961410522, 0.41084206104279, 0.43391978740692, 0.41296005249023, 0.49008846282959, 0.4501394033432, 0.58249080181122, 0.42263555526733, 0.41827642917633, 0.46844124794006, 0.42269110679626, 0.41941952705383, 0.42729496955872, 0.46311438083649, 0.49225616455078, 0.42109298706055, 0.44776225090027, 0.39763307571411, 0.39391183853149, 0.35214960575104, 0.4130654335022, 0.38502168655396, 0.50490379333496 ];
);

(
~shesme.tttt.peakTimes = [ 0.03507936373353, 0.050952382385731, 0.012403627857566, 0.035124715417624, 0.020748298615217, 0.018458049744368, 0.027528345584869, 0.026303855702281, 0.052086167037487, 0.0065986393019557, 0.0092517007142305, 0.097324259579182, 0.024920634925365, 0.031496599316597, 0.080725625157356, 0.033424034714699, 0.014807255938649, 0.019841270521283, 0.059977322816849, 0.012857142835855, 0.02897959202528, 0.040136054158211, 0.022063491865993, 0.0096598640084267, 0.087369613349438, 0.040362812578678, 0.029886621981859, 0.023741496726871, 0.061360545456409, 0.033401358872652, 0.14884354174137, 0.010952381417155, 0.025555554777384, 0.11043083667755, 0.011337868869305, 0.023900227621198, 0.047959182411432, 0.026938775554299, 0.02648526057601, 0.074353739619255, 0.12378685176373, 0.067959181964397, 0.031111111864448, 0.02700680308044, 0.015668934211135, 0.070884354412556, 0.071678005158901, 0.045396827161312, 0.14607709646225, 0.015147392638028, 0.050907030701637, 0.037664398550987, 0.034081634134054, 0.035941042006016, 0.085941046476364, 0.049455780535936, 0.010136054828763, 0.017528343945742, 0.026598639786243, 0.024807255715132, 0.019002268090844, 0.0069387755356729, 0.037755101919174, 0.015396825037897, 0.027528345584869, 0.022154195234179, 0.058526076376438, 0.012698412872851, 0.042879819869995, 0.0061678006313741, 0.013083900325, 0.037664398550987, 0.034535147249699, 0.1000907048583, 0.037097506225109, 0.021496599540114, 0.017959183081985, 0.016802720725536, 0.010204081423581, 0.0071882084012032, 0.03625850379467, 0.028503401204944, 0.060408163815737, 0.041496597230434, 0.030476190149784, 0.10403627902269, 0.06392290443182, 0.072063490748405, 0.032380953431129, 0.012811791151762, 0.030294785276055, 0.067346937954426, 0.021519273519516, 0.019092969596386, 0.025056689977646, 0.024399092420936, 0.020770974457264, 0.032199546694756, 0.030521541833878, 0.020680272951722, 0.067845806479454, 0.026666667312384, 0.027029478922486, 0.019773242995143, 0.032244898378849, 0.032630383968353, 0.042063493281603, 0.021201813593507, 0.028480725362897, 0.036371883004904, 0.031882084906101, 0.044965986162424, 0.049251701682806, 0.040521543473005, 0.039501134306192, 0.018571428954601, 0.039160996675491, 0.023219954222441, 0.018095238134265, 0.01206349208951, 0.010952381417155, 0.030975056812167, 0.02111111022532, 0.013106576167047, 0.030702948570251, 0.04832199588418, 0.082925170660019, 0.05074829980731, 0.0074376417323947, 0.091088436543941, 0.13444444537163, 0.012653061188757, 0.15628117322922, 0.039433106780052, 0.0083673465996981, 0.025396825745702, 0.047891154885292, 0.014308390207589, 0.015736961737275, 0.033061224967241, 0.038140591233969, 0.010975056327879, 0.010498866438866, 0.023764172568917, 0.027437642216682, 0.081201814115047, 0.056394558399916, 0.027460318058729, 0.023242630064487, 0.0348752848804, 0.039682541042566, 0.0090476190671325, 0.011315193027258, 0.0093424040824175, 0.085215419530869, 0.029387755319476, 0.012199546210468, 0.087301589548588, 0.04090702906251, 0.089637190103531, 0.014512471854687, 0.079070292413235, 0.078231289982796, 0.0092743765562773, 0.023333333432674, 0.024988662451506, 0.014603174291551, 0.016303854063153, 0.053061224520206, 0.0076643992215395, 0.012607709504664, 0.015351474285126, 0.015941042453051, 0.034557823091745, 0.031904760748148, 0.015079365111887, 0.014512471854687, 0.082607708871365, 0.011065759696066, 0.0080952383577824, 0.041723355650902, 0.021723356097937, 0.087482996284962, 0.08360543847084, 0.023378685116768, 0.057052154093981, 0.039909295737743, 0.015056689269841, 0.026984127238393, 0.026439908891916, 0.0090702949091792, 0.013174602761865, 0.0099546480923891, 0.0070975054986775, 0.0093424040824175, 0.0078231291845441, 0.010158729739487, 0.040725622326136, 0.008458049967885, 0.024013604968786, 0.060022674500942, 0.094580501317978, 0.0086848074570298, 0.047097504138947, 0.025895692408085, 0.034421768039465, 0.043514739722013, 0.061609975993633, 0.036417234688997, 0.06891156733036, 0.029886621981859, 0.015963718295097, 0.052176870405674, 0.018117913976312, 0.027619047090411, 0.083673469722271, 0.029410431161523, 0.038730159401894, 0.026281179860234, 0.033015873283148, 0.055691611021757, 0.13260771334171, 0.068027213215828, 0.11396825313568, 0.011746032163501, 0.077505670487881, 0.030702948570251, 0.046371880918741, 0.031972788274288, 0.039024941623211, 0.019841270521283, 0.054829932749271, 0.06301587074995, 0.043356008827686, 0.04346938803792, 0.0090476190671325, 0.0542176887393, 0.051678005605936, 0.025215419009328, 0.026122448965907, 0.047732427716255, 0.023696145042777, 0.017392290756106, 0.017324263229966, 0.018616780638695, 0.018956916406751, 0.010612244717777, 0.016575964167714, 0.016643991693854, 0.018390022218227, 0.010204081423581, 0.018730157986283, 0.0089795915409923, 0.024331064894795, 0.010136054828763, 0.016598640009761, 0.030022675171494, 0.01199546456337, 0.0092517007142305, 0.022630386054516, 0.010793650522828, 0.024217687547207, 0.026825396344066, 0.047052152454853, 0.019387755542994, 0.025759637355804, 0.026326529681683, 0.040022674947977, 0.010068027302623, 0.062335599213839, 0.038344670087099, 0.018911564722657, 0.020045351237059, 0.018208617344499, 0.011768707074225, 0.099501132965088, 0.016258504241705, 0.036303855478764, 0.037256237119436, 0.02707483060658, 0.030929705128074, 0.025238094851375, 0.020566893741488, 0.0307482983917, 0.022494331002235, 0.025374149903655, 0.031950112432241, 0.010566893033683, 0.028435373678803, 0.032993197441101, 0.023832200095057, 0.020204082131386, 0.021473923698068, 0.020136054605246, 0.039070293307304, 0.026825396344066, 0.095578230917454, 0.039886619895697 ];
);

)