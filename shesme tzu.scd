(
~shesme = ~shesme ? EM();

~shesme.tzu = ~shesme.tzu ? EM();

[ \amp, 0.1 ].pairsDo({ |key,value|
	~shesme.tzu[ key ] = value;
	~shesme.tzu[ key.asSetter ] = { |evt, val|
		evt[ key ] = val;
		evt.synths.do(_.set( key, val) );
	};
});

~shesme.tzu.loadBuffers = { |evt, action|
	evt.buffers = Buffer.readDir( "/Users/woutersnoei/Dropbox/Work/shesme/samples/tzu", 
		action: action ); 
};

(
SynthDef( "shesme_tzu", { |amp = 0.1, gain = 1, pan = 0, rate = 1, dur = 100, bufnum = 0, gate = 1|
	var sig;
	sig = PlayBuf.ar( 1, bufnum, rate, doneAction: 2 ) * Env([1,1,0],[dur,0.1]).kr(2);
	sig = RoundPan.ar(4, sig * amp.lag(0.1) * gain, pan);
	OffsetOut.ar( 0, sig * Env.cutoff.kr(2,gate) );
}).load(s);
);

/*
~shesme.tzu.loadBuffers;
~shesme.tzu.buffers.size;
*/

(
~shesme.tzu.start = { |evt|
	evt.end;
	evt.task = {
		var stream, index = 0, hist = [];
		
		stream = (
			Pstutter( Pwhite(2,5, inf), Pwhite(0.0,1.0).linexp(0,1,0.1,5) ) 
			* Pwhite(0.95,1.05, inf)
		).asStream;
		
		inf.do({
			index = (evt.buffers.size - 1).rand.asInt;
			while { hist.includes( index ) } {
				index = (evt.buffers.size - 1).rand.asInt;
			};
			hist = hist.insert( 0, index )[..3];
			evt.synths = evt.synths.add( 
				Synth.sched( 0.2, "shesme_tzu", [ 
					\bufnum, evt.buffers[index], 
					
					\amp, (evt.amp ? 0.1),
					\gain, 1 / (evt.rms[ index ] / evt.rms.mean), 
					\pan, 0.25.rand2,
					// \dur, 1,
					\rate, ((evt.freqs[ index ].cpsmidi.round + 1.rand2).midicps ) /
						evt.freqs[ index ]
				] ).freeAction_({ |synth| evt.synths.remove( synth ) })
			);
			stream.next.wait;
		})
	}.fork;
};

~shesme.tzu.end = { |evt|
	evt.task.stop;
	evt.task = nil;
	{ 0.2.wait; evt.synths.do(_.release); }.fork;
};
);

/*
~shesme.tzu.start;
~shesme.tzu.end;
~shesme.tzu.amp = 0.1;
*/

( // measured peak data
~shesme.tzu.peaks = [ 0.36172199249268, 0.44745218753815, 0.405681848526, 0.21784818172455, 0.44623816013336, 0.47481000423431, 0.23829102516174, 0.46867406368256, 0.42691445350647, 0.51017999649048, 0.56070625782013, 0.40502965450287, 0.564377784729, 0.84228444099426, 0.78151285648346, 0.8805068731308, 0.96204519271851, 0.75857770442963, 0.26027357578278, 0.4228595495224, 0.4756805896759, 0.65313053131104, 0.65313053131104, 0.51725661754608, 0.73694884777069, 0.73683106899261, 0.64530122280121, 0.4020220041275, 0.48759794235229, 0.44587159156799, 0.46778380870819, 0.68644142150879, 0.44731259346008, 0.45388793945312, 0.65485453605652, 0.71868562698364, 0.55225598812103, 0.61542189121246, 0.34026372432709, 0.2686882019043, 0.37616419792175, 0.38709318637848, 0.64417707920074, 0.37762355804443, 0.64686119556427, 0.70551288127899, 0.68237733840942, 0.71098732948303, 0.29973256587982, 0.50666272640228, 0.85377192497253, 0.87575948238373, 0.75479805469513, 0.47781240940094, 0.53509116172791, 0.77995347976685, 0.52413809299469, 0.58950328826904 ];
);

( // measured rms data
~shesme.tzu.rms = [ 0.19403174519539, 0.18190608918667, 0.22472609579563, 0.086594566702843, 0.1624544262886, 0.18184082210064, 0.09315699338913, 0.20697849988937, 0.2361054122448, 0.26065617799759, 0.25744652748108, 0.11063107848167, 0.24376009404659, 0.15850216150284, 0.13458137214184, 0.22955410182476, 0.27796810865402, 0.26101312041283, 0.083174474537373, 0.074795551598072, 0.062857255339622, 0.25882133841515, 0.3018316924572, 0.23406602442265, 0.30853474140167, 0.2942242026329, 0.22200368344784, 0.12262706458569, 0.18598674237728, 0.14937552809715, 0.16287451982498, 0.25574794411659, 0.13167689740658, 0.1481758505106, 0.19005556404591, 0.20645782351494, 0.20736768841743, 0.23343776166439, 0.10197126120329, 0.093843840062618, 0.1043521463871, 0.10601286590099, 0.18915556371212, 0.13290859758854, 0.18338739871979, 0.20490506291389, 0.18515925109386, 0.2094459682703, 0.1104247495532, 0.19471798837185, 0.21301792562008, 0.23366011679173, 0.24806973338127, 0.21093280613422, 0.20324961841106, 0.19814668595791, 0.2155636548996, 0.23043015599251 ];
);

( // measured pitch data
~shesme.tzu.freqs = [ 661.72674560547, 496.36047363281, 696.19018554688, 288.87182617188, 347.71966552734, 391.4482421875, 255.31860351562, 307.83453369141, 347.73718261719, 412.05847167969, 624.95617675781, 195.93388366699, 686.66345214844, 436.41275024414, 384.45114135742, 490.0888671875, 509.21594238281, 573.73529052734, 290.74606323242, 257.47354125977, 226.25886535645, 646.78497314453, 740.49560546875, 827.62872314453, 939.90612792969, 711.00793457031, 495.9677734375, 323.7265625, 374.12854003906, 258.20397949219, 286.62747192383, 456.30233764648, 300.75521850586, 320.8469543457, 333.72207641602, 354.38333129883, 351.18923950195, 372.02871704102, 243.75894165039, 259.96478271484, 274.54867553711, 288.74020385742, 471.48999023438, 312.07708740234, 555.24200439453, 517.80279541016, 493.66015625, 612.99114990234, 275.45971679688, 434.0950012207, 411.62261962891, 552.36590576172, 616.87445068359, 335.27886962891, 418.29107666016, 396.2487487793, 493.20639038086, 582.41998291016 ]
);

)